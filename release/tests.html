<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>err403 UI Library - Tests</title>
    <link rel="stylesheet" href="ui-lib.styles.css">
    <style>
      .test-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }

      .btn {
        background: #0078d4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: background 0.2s;
        width: 100%;
      }

      .btn:hover {
        background: #106ebe;
      }

      .btn:active {
        background: #005a9e;
      }

      .btn-secondary {
        background: #323130;
      }

      .btn-secondary:hover {
        background: #484644;
      }

      .test-results {
        margin-top: 16px;
        padding: 12px;
        background: #252525;
        border-radius: 4px;
        font-family: 'Consolas', monospace;
        font-size: 12px;
        color: #00ff00;
        max-height: 200px;
        overflow-y: auto;
      }

      .test-results:empty {
        display: none;
      }

      .status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 12px;
      }

      .status.success {
        background: #107c10;
        color: white;
      }

      .status.pending {
        background: #faa500;
        color: white;
      }

      .status.error {
        background: #d13438;
        color: white;
      }

      .info-box {
        background: #004578;
        border-left: 4px solid #0078d4;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 4px;
        font-size: 13px;
      }

      .warning-box {
        background: #4a3800;
        border-left: 4px solid #faa500;
        padding: 12px 16px;
        margin-bottom: 16px;
        border-radius: 4px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="page-header">
        <h1>üß™ err403 UI Library - Test Suite</h1>
        <p>Automated and manual tests for Dynamics 365 CE</p>
      </div>

      <div class="message info">
        ‚ÑπÔ∏è This page tests the err403 UI Library components in a D365
        environment. Click the buttons below to run individual tests.
      </div>

      <!-- Toast Tests -->
      <div class="section">
        <h2>Toast Component Tests</h2>
        <div class="test-grid">
          <button class="btn" onclick="testToastSuccess()">
            Success Toast
          </button>
          <button class="btn" onclick="testToastInfo()">Info Toast</button>
          <button class="btn" onclick="testToastWarning()">
            Warning Toast
          </button>
          <button class="btn" onclick="testToastError()">Error Toast</button>
          <button class="btn" onclick="testToastCustom()">Custom Toast</button>
          <button class="btn" onclick="testToastWithSound()">
            Toast with Sound
          </button>
          <button class="btn" onclick="testToastStacking()">
            Stack Multiple Toasts
          </button>
          <button class="btn" onclick="testToastAutoDismiss()">
            Auto-Dismiss Test
          </button>
        </div>
        <div id="toast-results" class="test-results"></div>
      </div>

      <!-- Modal Tests -->
      <div class="test-section">
        <h2>Modal Component Tests</h2>
        <div class="test-grid">
          <button class="btn" onclick="testModalBasic()">Basic Modal</button>
          <button class="btn" onclick="testModalForm()">
            Form with Validation
          </button>
          <button class="btn" onclick="testModalTabs()">Tabbed Modal</button>
          <button class="btn" onclick="testModalProgress()">
            Progress Modal
          </button>
          <button class="btn" onclick="testModalSideCart()">
            Side Cart Modal
          </button>
          <button class="btn" onclick="testModalDraggable()">
            Draggable Modal
          </button>
          <button class="btn" onclick="testModalAllFields()">
            All Field Types
          </button>
          <button class="btn" onclick="testModalNested()">Nested Modals</button>
        </div>
        <div id="modal-results" class="test-results"></div>
      </div>

      <!-- Advanced Modal Tests -->
      <div class="test-section">
        <h2>Advanced Modal Tests</h2>
        <div class="test-grid">
          <button class="btn" onclick="testModalWizard()">
            Multi-Step Wizard
          </button>
          <button class="btn" onclick="testModalValidation()">
            Field Validation
          </button>
          <button class="btn" onclick="testModalAlert()">
            Modal.alert()
          </button>
          <button class="btn" onclick="testModalConfirm()">
            Modal.confirm()
          </button>
          <button class="btn" onclick="testModalToggleRange()">
            Toggle & Range Fields
          </button>
          <button class="btn" onclick="testModalDateRange()">
            Date Range Field
          </button>
          <button class="btn" onclick="testModalCustomField()">
            Custom Field Render
          </button>
          <button class="btn" onclick="testModalChaining()">
            Method Chaining
          </button>
          <button class="btn" onclick="testModalPreventClose()">
            Prevent Close Button
          </button>
          <button class="btn" onclick="testModalDestructive()">
            Destructive Button
          </button>
          <button class="btn" onclick="testModalSizes()">
            Modal Sizes
          </button>
          <button class="btn" onclick="testModalIcons()">
            Modal Icons
          </button>
        </div>
        <div id="modal-advanced-results" class="test-results"></div>
      </div>

      <!-- Lookup Tests -->
      <div class="test-section">
        <h2>Lookup Component Tests</h2>
        <div class="warning-box">
          ‚ö†Ô∏è Lookup tests use mock data when Xrm API is not available. For full
          testing, run this page within a D365 form context.
        </div>
        <div class="test-grid">
          <button class="btn" onclick="testLookupBasic()">Basic Lookup</button>
          <button class="btn" onclick="testLookupMultiSelect()">
            Multi-Select Lookup
          </button>
          <button class="btn" onclick="testLookupAdvanced()">
            Advanced Lookup
          </button>
          <button class="btn" onclick="testLookupSearch()">
            Search Functionality
          </button>
          <button class="btn" onclick="testLookupPagination()">
            Pagination Test
          </button>
          <button class="btn" onclick="testLookupSorting()">
            Column Sorting
          </button>
          <button class="btn" onclick="testLookupFilters()">
            FetchXML Filters
          </button>
          <button class="btn" onclick="testLookupMetadata()">
            Metadata Caching
          </button>
        </div>
        <div id="lookup-results" class="test-results"></div>
      </div>

      <!-- Logger Tests -->
      <div class="test-section">
        <h2>Logger Utility Tests</h2>
        <div class="test-grid">
          <button class="btn" onclick="testLoggerBug()">BUG Log</button>
          <button class="btn" onclick="testLoggerWarning()">WAR Log</button>
          <button class="btn" onclick="testLoggerError()">ERR Log</button>
          <button class="btn" onclick="testLoggerMultiple()">
            Multiple Logs
          </button>
        </div>
        <div id="logger-results" class="test-results"></div>
      </div>

      <!-- Integration Tests -->
      <div class="test-section">
        <h2>Integration Tests</h2>
        <div class="test-grid">
          <button class="btn" onclick="testModalWithToast()">
            Modal + Toast
          </button>
          <button class="btn" onclick="testLookupInModal()">
            Lookup in Modal
          </button>
          <button class="btn" onclick="testErrorHandling()">
            Error Handling
          </button>
          <button class="btn btn-secondary" onclick="runAllTests()">
            üöÄ Run All Tests
          </button>
        </div>
        <div id="integration-results" class="test-results"></div>
      </div>
    </div>

    <!-- Load the library -->
    <script src="ui-lib.min.js"></script>

    <script>
      // Verify library is loaded
      if (typeof err403 === 'undefined') {
        console.error('err403 library failed to load!');
        alert('Error: err403 library not loaded. Check console for details.');
      } else {
        console.log('‚úì err403 library loaded successfully');
      }

      // Helper function to log test results
      function logResult(section, message, status = 'success') {
        const resultsDiv = document.getElementById(`${section}-results`);
        const timestamp = new Date().toLocaleTimeString();
        const color = status === 'success' ? '#00ff00' : status === 'error' ? '#ff0000' : '#ffaa00';
        resultsDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
        resultsDiv.scrollTop = resultsDiv.scrollHeight;
      }

      function clearResults(section) {
        document.getElementById(`${section}-results`).innerHTML = '';
      }

      // Helper for Modal tests (Modal not implemented yet)
      function testModalPlaceholder(testName) {
        clearResults('modal');
        logResult('modal', `Test: ${testName}`, 'warning');
        logResult('modal', '‚ö†Ô∏è Modal component not implemented yet', 'warning');
        logResult('modal', 'Only Toast and Lookup are currently functional', 'warning');
      }

      // ========== Toast Tests ==========
      function testToastSuccess() {
        clearResults('toast');
        logResult('toast', 'Testing success toast...');

        if (!err403 || !err403.Toast) {
          logResult('toast', '‚úó err403.Toast not available!', 'error');
          console.error('err403.Toast is not defined:', err403);
          return;
        }

        err403.Toast.success({
          title: 'Success',
          message: 'Test successful!',
          duration: 3000
        });
        logResult('toast', '‚úì Success toast displayed');
      }

      function testToastInfo() {
        clearResults('toast');
        logResult('toast', 'Testing info toast...');
        err403.Toast.info({
          title: 'Info',
          message: 'This is an info message',
          duration: 3000
        });
        logResult('toast', '‚úì Info toast displayed');
      }

      function testToastWarning() {
        clearResults('toast');
        logResult('toast', 'Testing warning toast...');
        err403.Toast.warn({
          title: 'Warning',
          message: 'Warning: This is a test',
          duration: 3000
        });
        logResult('toast', '‚úì Warning toast displayed');
      }

      function testToastError() {
        clearResults('toast');
        logResult('toast', 'Testing error toast...');
        err403.Toast.error({
          title: 'Error',
          message: 'Error: Test failed',
          duration: 3000
        });
        logResult('toast', '‚úì Error toast displayed');
      }

      function testToastCustom() {
        clearResults('toast');
        logResult('toast', 'Testing custom toast...');
        err403.Toast.show({
          type: 'custom',
          message: 'Custom styled toast',
          bgColor: '#6264A7',
          textColor: '#ffffff',
          duration: 3000
        });
        logResult('toast', '‚úì Custom toast displayed');
      }

      function testToastWithSound() {
        clearResults('toast');
        logResult('toast', 'Testing toast with sound...');
        err403.Toast.show({
          type: 'success',
          message: 'Toast with sound!',
          sound: true,
          duration: 3000
        });
        logResult('toast', '‚úì Toast with sound displayed');
      }

      function testToastStacking() {
        clearResults('toast');
        logResult('toast', 'Testing toast stacking (6 toasts)...');
        for (let i = 1; i <= 6; i++) {
          setTimeout(() => {
            err403.Toast.show({
              type: i % 2 === 0 ? 'success' : 'info',
              message: `Toast ${i} of 6`,
              duration: 5000
            });
          }, i * 200);
        }
        logResult('toast', '‚úì Multiple toasts stacked (max 5 visible)');
      }

      function testToastAutoDismiss() {
        clearResults('toast');
        logResult('toast', 'Testing auto-dismiss (2 seconds)...');
        err403.Toast.show({
          type: 'info',
          message: 'This will auto-dismiss in 2 seconds',
          duration: 2000
        });
        setTimeout(() => {
          logResult('toast', '‚úì Toast auto-dismissed');
        }, 2500);
      }

      // ========== Modal Tests ==========
      function testModalBasic() {
        clearResults('modal');
        logResult('modal', 'Testing Modal component...');
        try {
          const modal = new err403.Modal({
            title: 'Basic Modal Test',
            message: 'This is a basic modal for testing.',
            buttons: [
              new err403.Button('OK', () => {
                logResult('modal', '‚úì Basic modal closed via OK button');
              }, true)
            ]
          });
          modal.show();
          logResult('modal', '‚úì Modal component instantiated');
        } catch (e) {
          logResult('modal', '‚úó Modal error: ' + e.message);
          console.error('Modal component error:', e);
        }
        logResult('modal', '‚úì Basic modal opened');
      }

      function testModalForm() {
        clearResults('modal');
        logResult('modal', 'Opening form modal with validation...');
        const modal = new err403.Modal({
          title: 'Form Test',
          fields: [
            new err403.Input({
              id: 'email',
              label: 'Email',
              type: 'text',
              required: true,
              placeholder: 'Enter email address'
            }),
            new err403.Input({
              id: 'age',
              label: 'Age',
              type: 'number',
              required: true,
              extraAttributes: { min: 18, max: 100 }
            })
          ],
          buttons: [
            new err403.Button('Cancel', () => {
              logResult('modal', 'Form cancelled');
            }),
            new err403.Button('Submit', () => {
              const data = modal.getFieldValues();
              logResult('modal', `‚úì Form submitted: ${JSON.stringify(data)}`);
            }, true)
          ]
        });
        modal.show();
        logResult('modal', '‚úì Form modal opened');
      }

      function testModalTabs() {
        clearResults('modal');
        logResult('modal', 'Opening tabbed modal using Group...');
        const modal = new err403.Modal({
          title: 'Tabbed Modal Test',
          fields: [
            new err403.Group({
              id: 'tabs',
              asTabs: true,
              fields: [
                new err403.Group({
                  id: 'tab1',
                  label: 'General',
                  fields: [
                    new err403.Input({ id: 'name', label: 'Name', type: 'text' })
                  ]
                }),
                new err403.Group({
                  id: 'tab2',
                  label: 'Details',
                  fields: [
                    new err403.MultiLine({ id: 'desc', label: 'Description', rows: 4 })
                  ]
                })
              ]
            })
          ],
          buttons: [
            new err403.Button('Close', () => {
              logResult('modal', '‚úì Tabbed modal closed');
            }, true)
          ]
        });
        modal.show();
        logResult('modal', '‚úì Tabbed modal opened');
      }

      function testModalProgress() {
        clearResults('modal');
        logResult('modal', 'Opening progress bar modal...');
        const modal = err403.Modal.open({
          title: 'Progress Test',
          message: 'Processing items...',
          progress: {
            enabled: true,
            type: 'bar',
            currentStep: 0,
            totalSteps: 100
          },
          buttons: []
        });

        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          modal.updateProgress(progress);
          if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
              modal.close();
              logResult('modal', '‚úì Progress modal completed and closed');
            }, 500);
          }
        }, 200);
        logResult('modal', '‚úì Progress modal opened with progress bar');
      }

      function testModalSideCart() {
        clearResults('modal');
        logResult('modal', 'Opening side cart modal...');
        err403.Modal.open({
          title: 'Side Cart Test',
          message: 'Main content area with side information panel',
          sideCart: {
            enabled: true,
            position: 'right',
            width: 300,
            content: '<h3>Additional Info</h3><p>This is the side cart content</p><ul><li>Feature 1</li><li>Feature 2</li><li>Feature 3</li></ul>',
            backgroundColor: '#f3f2f1'
          },
          buttons: [
            new err403.Button('Close', () => {
              logResult('modal', '‚úì Side cart modal closed');
            }, true)
          ]
        });
        logResult('modal', '‚úì Side cart modal opened');
      }

      function testModalDraggable() {
        clearResults('modal');
        logResult('modal', 'Opening draggable modal...');
        const modal = new err403.Modal({
          title: 'Draggable Modal Test',
          message: 'Try dragging this modal by the title bar!',
          draggable: true,
          buttons: [
            new err403.Button('Close', () => {
              logResult('modal', '‚úì Draggable modal closed');
            }, true)
          ]
        });
        modal.show();
        logResult('modal', '‚úì Draggable modal opened');
      }

      function testModalAllFields() {
        clearResults('modal');
        logResult('modal', 'Opening modal with all field types...');
        const modal = new err403.Modal({
          title: 'All Field Types Test',
          fields: [
            new err403.Input({ id: 'text', label: 'Text Input', type: 'text', placeholder: 'Enter text...' }),
            new err403.Input({ id: 'number', label: 'Number Input', type: 'number', value: 42 }),
            new err403.Input({ id: 'email', label: 'Email Input', type: 'email', placeholder: 'user@example.com' }),
            new err403.Input({ id: 'password', label: 'Password Input', type: 'password' }),
            new err403.Input({ id: 'date', label: 'Date Input', type: 'date', value: '2024-01-15' }),
            new err403.Input({ id: 'time', label: 'Time Input', type: 'time', value: '14:30' }),
            new err403.Input({ id: 'checkbox', label: 'Checkbox', type: 'checkbox', value: true }),
            new err403.Input({ id: 'toggle', label: 'Toggle Switch', type: 'checkbox', value: false }),
            new err403.Input({ id: 'range', label: 'Range Slider', type: 'range', value: 50, extraAttributes: { min: 0, max: 100 }, showValue: true }),
            new err403.Input({ id: 'file', label: 'File Upload', type: 'file' }),
            new err403.OptionSet({ 
              id: 'select', 
              label: 'Dropdown Select', 
              options: [
                { label: 'Option 1', value: '1' },
                { label: 'Option 2', value: '2' },
                { label: 'Option 3', value: '3' }
              ],
              value: '2'
            }),
            new err403.MultiLine({ id: 'textarea', label: 'Text Area', rows: 4, placeholder: 'Enter multiple lines...' }),
            new err403.DateRange({ 
              id: 'daterange', 
              label: 'Date Range', 
              startDate: new Date('2024-01-01'),
              endDate: new Date('2024-12-31')
            })
          ],
          buttons: [
            new err403.Button('Get Values', () => {
              const data = modal.getFieldValues();
              console.log('All field values:', data);
              logResult('modal', `‚úì Values retrieved: ${Object.keys(data).length} fields`);
              return false;
            }),
            new err403.Button('Close', () => {
              logResult('modal', '‚úì All fields modal closed');
            }, true)
          ]
        });
        modal.show();
        logResult('modal', '‚úì Modal with 13 different field types opened');
      }

      function testModalNested() {
        clearResults('modal');
        logResult('modal', 'Opening nested modals...');
        const modal1 = new err403.Modal({
          title: 'First Modal',
          message: 'This is the first modal',
          buttons: [
            new err403.Button('Open Second Modal', () => {
              const modal2 = new err403.Modal({
                title: 'Second Modal',
                message: 'This is nested inside the first modal',
                buttons: [
                  new err403.Button('Close', () => {
                    logResult('modal', '‚úì Second (nested) modal closed');
                  }, true)
                ]
              });
              modal2.show();
              logResult('modal', '‚úì Second modal opened (nested)');
              return false; // Don't close first modal
            }, true)
          ]
        });
        modal1.show();
        logResult('modal', '‚úì First modal opened');
      }

      // ========== Advanced Modal Tests ==========
      function testModalWizard() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Opening multi-step wizard modal...');
        const modal = err403.Modal.open({
          title: 'Account Setup Wizard',
          progress: {
            enabled: true,
            type: 'steps-left',
            currentStep: 1,
            totalSteps: 3,
            steps: [
              {
                id: 'step1',
                label: 'Basic Info',
                name: 'Basic Information',
                description: 'Enter account details',
                fields: [
                  new err403.Input({ id: 'accountName', label: 'Account Name', type: 'text', required: true }),
                  new err403.Input({ id: 'email', label: 'Email', type: 'email', required: true })
                ]
              },
              {
                id: 'step2',
                label: 'Address',
                name: 'Address Details',
                description: 'Enter address information',
                fields: [
                  new err403.Input({ id: 'street', label: 'Street', type: 'text' }),
                  new err403.Input({ id: 'city', label: 'City', type: 'text' })
                ]
              },
              {
                id: 'step3',
                label: 'Review',
                name: 'Review & Submit',
                description: 'Review your information',
                fields: [
                  new err403.MultiLine({ id: 'notes', label: 'Additional Notes', rows: 3 })
                ]
              }
            ],
            allowStepNavigation: true
          },
          buttons: [
            new err403.Button('Previous', () => {
              modal.previousStep();
              return false;
            }),
            new err403.Button('Next', () => {
              modal.nextStep();
              return false;
            }, true),
            new err403.Button('Finish', () => {
              const data = modal.getFieldValues();
              logResult('modal-advanced', `‚úì Wizard completed: ${JSON.stringify(data)}`);
            }, true)
          ]
        });
        logResult('modal-advanced', '‚úì Multi-step wizard opened');
      }

      function testModalValidation() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Opening modal with field validation...');
        const modal = new err403.Modal({
          title: 'Form Validation Test',
          fields: [
            new err403.Input({
              id: 'email',
              label: 'Email Address',
              type: 'email',
              required: true,
              placeholder: 'user@example.com',
              validation: {
                rules: [
                  { type: 'required', message: 'Email is required' },
                  { type: 'email', message: 'Must be a valid email' }
                ],
                showErrors: true
              }
            }),
            new err403.Input({
              id: 'password',
              label: 'Password',
              type: 'password',
              required: true,
              validation: {
                rules: [
                  { type: 'required', message: 'Password is required' },
                  { type: 'minLength', value: 8, message: 'Password must be at least 8 characters' }
                ],
                showErrors: true
              }
            }),
            new err403.Input({
              id: 'age',
              label: 'Age',
              type: 'number',
              required: true,
              extraAttributes: { min: 18, max: 100 }
            })
          ],
          buttons: [
            new err403.Button('Cancel', () => {
              logResult('modal-advanced', 'Validation test cancelled');
            }),
            new err403.Button('Submit', () => {
              if (modal.validateAllFields()) {
                const data = modal.getFieldValues();
                logResult('modal-advanced', `‚úì Validation passed: ${JSON.stringify(data)}`);
              } else {
                logResult('modal-advanced', '‚úó Validation failed - check fields', 'error');
                return false;
              }
            }, true)
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Validation modal opened - try submitting with invalid data');
      }

      function testModalAlert() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing Modal.alert() static method...');
        err403.Modal.alert('Alert', 'This is an alert message using Modal.alert()')
          .then(() => {
            logResult('modal-advanced', '‚úì Alert closed');
          });
        logResult('modal-advanced', '‚úì Alert displayed');
      }

      function testModalConfirm() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing Modal.confirm() static method...');
        err403.Modal.confirm('Confirm Action', 'Are you sure you want to proceed?')
          .then((result) => {
            if (result) {
              logResult('modal-advanced', '‚úì User clicked OK');
            } else {
              logResult('modal-advanced', '‚úì User clicked Cancel');
            }
          });
        logResult('modal-advanced', '‚úì Confirmation dialog displayed');
      }

      function testModalToggleRange() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Opening modal with toggle and range inputs...');
        const modal = new err403.Modal({
          title: 'Toggle & Range Test',
          fields: [
            new err403.Input({
              id: 'enableNotifications',
              label: 'Enable Notifications',
              type: 'checkbox',
              value: true
            }),
            new err403.Input({
              id: 'toggleDarkMode',
              label: 'Dark Mode',
              type: 'checkbox',
              value: false
            }),
            new err403.Input({
              id: 'volume',
              label: 'Volume Level',
              type: 'range',
              value: 50,
              extraAttributes: { min: 0, max: 100, step: 10 },
              showValue: true
            }),
            new err403.Input({
              id: 'quality',
              label: 'Quality',
              type: 'range',
              value: 75,
              extraAttributes: { min: 0, max: 100, step: 25 },
              showValue: true
            })
          ],
          buttons: [
            new err403.Button('Save', () => {
              const data = modal.getFieldValues();
              logResult('modal-advanced', `‚úì Settings saved: ${JSON.stringify(data)}`);
            }, true)
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Toggle and range fields displayed');
      }

      function testModalDateRange() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Opening modal with date range field...');
        const modal = new err403.Modal({
          title: 'Date Range Test',
          fields: [
            new err403.DateRange({
              id: 'reportPeriod',
              label: 'Report Period',
              startDate: new Date('2024-01-01'),
              endDate: new Date('2024-12-31')
            }),
            new err403.Input({
              id: 'startDate',
              label: 'Start Date',
              type: 'date',
              value: '2024-01-01'
            }),
            new err403.Input({
              id: 'endDate',
              label: 'End Date',
              type: 'date',
              value: '2024-12-31'
            })
          ],
          buttons: [
            new err403.Button('Generate Report', () => {
              const data = modal.getFieldValues();
              logResult('modal-advanced', `‚úì Date range selected: ${JSON.stringify(data)}`);
            }, true)
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Date range fields displayed');
      }

      function testModalCustomField() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Opening modal with custom render field...');
        const modal = new err403.Modal({
          title: 'Custom Field Test',
          fields: [
            new err403.Input({
              id: 'name',
              label: 'Name',
              type: 'text'
            }),
            new err403.Custom({
              id: 'customWidget',
              label: 'Custom Widget',
              render: () => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 16px; background: #f3f2f1; border-radius: 4px; border: 1px solid #edebe9;';
                div.innerHTML = `
                  <p style="margin: 0 0 8px 0; font-weight: 600;">Custom HTML Content</p>
                  <p style="margin: 0; font-size: 12px; color: #605e5c;">This field uses a custom render function to create any HTML content.</p>
                  <button onclick="alert('Custom button clicked!')" style="margin-top: 8px; padding: 6px 12px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer;">Click Me</button>
                `;
                return div;
              }
            })
          ],
          buttons: [
            new err403.Button('Close', () => {
              logResult('modal-advanced', '‚úì Custom field modal closed');
            }, true)
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Custom field rendered');
      }

      function testModalChaining() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing method chaining...');
        const modal = new err403.Modal({
          title: 'Initial Title',
          message: 'Initial message',
          buttons: [
            new err403.Button('Update Title', () => {
              modal.title('Updated Title via Chaining');
              logResult('modal-advanced', '‚úì Title updated using title() method');
              return false;
            }),
            new err403.Button('Update Size', () => {
              modal.width(800).height(600);
              logResult('modal-advanced', '‚úì Size updated using width() and height() methods');
              return false;
            }),
            new err403.Button('Close', () => {
              logResult('modal-advanced', '‚úì Method chaining test completed');
            }, true)
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Modal opened - try the update buttons');
      }

      function testModalPreventClose() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing preventClose button option...');
        const modal = new err403.Modal({
          title: 'Prevent Close Test',
          message: 'The "Don\'t Close" button keeps the modal open',
          buttons: [
            new err403.Button('Don\'t Close', () => {
              logResult('modal-advanced', '‚úì Button clicked but modal stays open (preventClose: true)');
              err403.Toast.info({ message: 'Modal stays open!', duration: 2000 });
            }, false, true), // preventClose = true
            new err403.Button('Close Modal', () => {
              logResult('modal-advanced', '‚úì Modal closed normally');
            }, true)
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Modal with preventClose button opened');
      }

      function testModalDestructive() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing destructive button styling...');
        const modal = new err403.Modal({
          title: 'Delete Account',
          message: 'This action cannot be undone. Are you sure?',
          icon: 'WARNING',
          buttons: [
            new err403.Button('Cancel', () => {
              logResult('modal-advanced', '‚úì Action cancelled');
            }),
            new err403.Button('Delete', () => {
              logResult('modal-advanced', '‚úì Destructive action confirmed');
            }, true, false, true) // isDestructive = true
          ]
        });
        modal.show();
        logResult('modal-advanced', '‚úì Modal with destructive button (red) opened');
      }

      function testModalSizes() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing different modal sizes...');
        
        const sizes = ['small', 'medium', 'large', 'fullscreen'];
        let currentSize = 0;
        
        function showNextSize() {
          if (currentSize >= sizes.length) {
            logResult('modal-advanced', '‚úì All modal sizes tested');
            return;
          }
          
          const size = sizes[currentSize];
          const modal = err403.Modal.open({
            title: `${size.toUpperCase()} Modal`,
            message: `This is a ${size} modal (${currentSize + 1}/${sizes.length})`,
            size: size,
            buttons: [
              new err403.Button('Next Size', () => {
                currentSize++;
                setTimeout(showNextSize, 300);
              }, true)
            ]
          });
          logResult('modal-advanced', `‚úì ${size} modal opened`);
        }
        
        showNextSize();
      }

      function testModalIcons() {
        clearResults('modal-advanced');
        logResult('modal-advanced', 'Testing modal icons...');
        
        const icons = ['INFO', 'SUCCESS', 'WARNING', 'ERROR', 'QUESTION'];
        let currentIcon = 0;
        
        function showNextIcon() {
          if (currentIcon >= icons.length) {
            logResult('modal-advanced', '‚úì All modal icons tested');
            return;
          }
          
          const icon = icons[currentIcon];
          const modal = err403.Modal.open({
            title: `${icon} Icon`,
            message: `This modal has a ${icon} icon (${currentIcon + 1}/${icons.length})`,
            icon: icon,
            buttons: [
              new err403.Button('Next Icon', () => {
                currentIcon++;
                setTimeout(showNextIcon, 300);
              }, true)
            ]
          });
          logResult('modal-advanced', `‚úì Modal with ${icon} icon opened`);
        }
        
        showNextIcon();
      }

      // ========== Lookup Tests ==========
      function testLookupBasic() {
        clearResults('lookup');
        logResult('lookup', 'Opening basic lookup...');
        err403.Lookup.open({
          entity: 'account',
          columns: ['name', 'accountnumber', 'telephone1', 'emailaddress1'],
          onSelect: (results) => {
            logResult('lookup', `‚úì Selected ${results.length} record(s): ${results.map(r => r.name).join(', ')}`);
          }
        });
        logResult('lookup', '‚úì Basic lookup opened');
      }

      function testLookupMultiSelect() {
        clearResults('lookup');
        logResult('lookup', 'Opening multi-select lookup...');
        err403.Lookup.open({
          entity: 'contact',
          columns: ['fullname', 'emailaddress1', 'telephone1'],
          multiSelect: true,
          onSelect: (results) => {
            logResult('lookup', `‚úì Selected ${results.length} contact(s)`);
          }
        });
        logResult('lookup', '‚úì Multi-select lookup opened');
      }

      function testLookupAdvanced() {
        clearResults('lookup');
        logResult('lookup', 'Opening advanced lookup with custom labels...');
        err403.Lookup.open({
          entity: 'account',
          columns: ['name', 'accountnumber', 'revenue', 'websiteurl'],
          columnLabels: {
            name: 'Account Name',
            accountnumber: 'Account #',
            revenue: 'Annual Revenue',
            websiteurl: 'Website'
          },
          orderBy: [{ attribute: 'revenue', descending: true }],
          onSelect: (results) => {
            logResult('lookup', `‚úì Selected: ${results[0]?.name || 'none'}`);
          }
        });
        logResult('lookup', '‚úì Advanced lookup opened');
      }

      function testLookupSearch() {
        clearResults('lookup');
        logResult('lookup', 'Testing search functionality...');
        err403.Lookup.open({
          entity: 'account',
          columns: ['name', 'accountnumber'],
          searchFields: ['name', 'accountnumber'],
          onSelect: (results) => {
            logResult('lookup', '‚úì Search test completed');
          }
        });
        logResult('lookup', '‚úì Lookup with search opened - try typing in the search box');
      }

      function testLookupPagination() {
        clearResults('lookup');
        logResult('lookup', 'Testing pagination...');
        err403.Lookup.open({
          entity: 'account',
          columns: ['name', 'accountnumber'],
          onSelect: (results) => {
            logResult('lookup', '‚úì Pagination test completed');
          }
        });
        logResult('lookup', '‚úì Lookup opened - test pagination with prev/next buttons');
      }

      function testLookupSorting() {
        clearResults('lookup');
        logResult('lookup', 'Testing column sorting...');
        err403.Lookup.open({
          entity: 'account',
          columns: ['name', 'accountnumber', 'revenue'],
          onSelect: (results) => {
            logResult('lookup', '‚úì Sorting test completed');
          }
        });
        logResult('lookup', '‚úì Lookup opened - click column headers to sort');
      }

      function testLookupFilters() {
        clearResults('lookup');
        logResult('lookup', 'Testing FetchXML filters...');
        err403.Lookup.open({
          entity: 'account',
          columns: ['name', 'accountnumber'],
          filters: '<filter><condition attribute="statecode" operator="eq" value="0" /></filter>',
          onSelect: (results) => {
            logResult('lookup', '‚úì Filter test completed');
          }
        });
        logResult('lookup', '‚úì Lookup with filters opened (active accounts only)');
      }

      function testLookupMetadata() {
        clearResults('lookup');
        logResult('lookup', 'Testing metadata caching...');
        // Open same lookup twice to test cache
        err403.Lookup.open({
          entity: 'account',
          columns: ['name'],
          onSelect: () => {
            logResult('lookup', '‚úì First lookup closed');
            setTimeout(() => {
              err403.Lookup.open({
                entity: 'account',
                columns: ['name'],
                onSelect: () => {
                  logResult('lookup', '‚úì Second lookup closed (metadata should be cached)');
                }
              });
            }, 500);
          }
        });
        logResult('lookup', '‚úì First lookup opened (metadata fetched)');
      }

      // ========== Logger Tests ==========
      function testLoggerBug() {
        clearResults('logger');
        logResult('logger', 'Testing BUG logger...');
        console.debug(...err403.BUG, 'Test bug log', { data: 'test' });
        logResult('logger', '‚úì BUG log written to console');
      }

      function testLoggerWarning() {
        clearResults('logger');
        logResult('logger', 'Testing WAR logger...');
        console.warn(...err403.WAR, 'Test warning log');
        logResult('logger', '‚úì WAR log written to console');
      }

      function testLoggerError() {
        clearResults('logger');
        logResult('logger', 'Testing ERR logger...');
        console.error(...err403.ERR, 'Test error log', new Error('Test error'));
        logResult('logger', '‚úì ERR log written to console');
      }

      function testLoggerMultiple() {
        clearResults('logger');
        logResult('logger', 'Testing multiple log types...');
        console.debug(...err403.BUG, 'Debug message');
        console.warn(...err403.WAR, 'Warning message');
        console.error(...err403.ERR, 'Error message');
        logResult('logger', '‚úì Multiple logs written - check browser console');
      }

      // ========== Integration Tests ==========
      function testModalWithToast() {
        clearResults('integration');
        logResult('integration', 'Testing Modal + Toast integration...');
        const modal = err403.Modal.open({
          title: 'Integration Test',
          message: 'Click OK to show a success toast',
          buttons: [
            new err403.Button('OK', () => {
              err403.Toast.success({
                title: 'Success',
                message: 'Modal closed, toast shown!',
                duration: 3000
              });
              logResult('integration', '‚úì Modal closed, toast displayed');
            }, true)
          ]
        });
        logResult('integration', '‚úì Modal opened');
      }

      function testLookupInModal() {
        clearResults('integration');
        logResult('integration', 'Testing Lookup in Modal...');
        err403.Modal.open({
          title: 'Select Account',
          message: 'Click the button to open a lookup dialog',
          fields: [
            new err403.Input({
              id: 'selectedAccount',
              label: 'Selected Account',
              type: 'text',
              disabled: true
            })
          ],
          buttons: [
            new err403.Button('Open Lookup', () => {
              err403.Lookup.open({
                entity: 'account',
                columns: ['name', 'accountnumber'],
                onSelect: (results) => {
                  if (results.length > 0) {
                    err403.Toast.success({
                      title: 'Account Selected',
                      message: `Selected: ${results[0]?.name || 'none'}`,
                      duration: 3000
                    });
                    logResult('integration', `‚úì Lookup completed from modal: ${results[0]?.name || 'none'}`);
                  }
                }
              });
              return false; // Don't close modal
            }, true),
            new err403.Button('Close', () => {
              logResult('integration', '‚úì Modal closed');
            })
          ]
        });
        logResult('integration', '‚úì Modal with lookup opened');
      }

      function testErrorHandling() {
        clearResults('integration');
        logResult('integration', 'Testing error handling...');
        try {
          // Test invalid toast type - should default to 'info'
          err403.Toast.show({
            type: 'invalidtype',
            message: 'This should use default type'
          });
          logResult('integration', '‚úì Invalid toast type handled gracefully');

          // Test empty modal
          const modal1 = err403.Modal.open({
            title: 'Minimal Modal',
            buttons: []
          });
          setTimeout(() => modal1.close(), 1000);
          logResult('integration', '‚úì Empty modal created');

          // Test modal with missing required options
          setTimeout(() => {
            err403.Modal.alert('Test', 'Alert without errors');
            logResult('integration', '‚úì Modal static methods work correctly');
          }, 1500);

        } catch (error) {
          logResult('integration', `‚úó Error: ${error.message}`, 'error');
        }
      }

      function runAllTests() {
        clearResults('integration');
        logResult('integration', 'üöÄ Running all automated tests...', 'pending');

        let testCount = 0;
        const tests = [
          // Toast tests
          () => { testToastSuccess(); testCount++; },
          () => { testToastInfo(); testCount++; },
          () => { testToastWarning(); testCount++; },
          () => { testToastError(); testCount++; },
          () => { testToastCustom(); testCount++; },
          
          // Logger tests
          () => { testLoggerBug(); testCount++; },
          () => { testLoggerWarning(); testCount++; },
          () => { testLoggerError(); testCount++; },
          () => { testLoggerMultiple(); testCount++; }
        ];

        tests.forEach((test, index) => {
          setTimeout(test, index * 500);
        });

        setTimeout(() => {
          logResult('integration', `‚úì Completed ${testCount} automated tests`);
          logResult('integration', '‚Ñπ Manual tests (modals, lookups, advanced modals) require user interaction');
          logResult('integration', `üìä Total test functions available: ${testCount + 20} (8 modal + 12 advanced modal + 8 lookup + integration tests)`);
        }, tests.length * 500 + 500);
      }

      // Log library loaded
      console.log('err403 UI Library Test Suite Loaded');
      console.log('Library version:', err403);
    </script>
  </body>
</html>
